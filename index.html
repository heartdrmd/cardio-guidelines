<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardiology Guidelines AI</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --bg-hover: #475569;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #475569;
            --class-i: #10b981;
            --class-iia: #3b82f6;
            --class-iib: #f59e0b;
            --class-iii: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        header {
            text-align: center;
            padding: 20px 20px;
            background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 50%, #1e1e3f 100%);
            border-bottom: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 30% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 70% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .logo { font-size: 1.8rem; margin-bottom: 5px; filter: drop-shadow(0 0 20px rgba(239, 68, 68, 0.5)); display: inline-block; vertical-align: middle; margin-right: 10px; }

        header h1 {
            font-size: 1.4rem; font-weight: 700; margin-bottom: 5px; display: inline-block; vertical-align: middle;
            background: linear-gradient(135deg, #f8fafc 0%, #94a3b8 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }

        header p { color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px; }

        .stats-bar { display: flex; justify-content: center; gap: 20px; margin-top: 12px; flex-wrap: wrap; }

        .stat {
            display: flex; flex-direction: row; align-items: center; gap: 8px;
            padding: 8px 15px; background: rgba(255,255,255,0.05);
            border-radius: 8px; border: 1px solid var(--border);
        }

        .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--accent-blue); }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); }

        .tabs {
            display: flex; gap: 8px; margin-bottom: 25px; padding: 5px;
            background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border);
        }

        .tab {
            flex: 1; padding: 14px 20px; background: transparent; border: none;
            border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 500;
            color: var(--text-secondary); transition: all 0.2s;
        }

        .tab:hover { color: var(--text-primary); background: var(--bg-card); }

        .tab.active {
            background: var(--accent-blue); color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .panel {
            display: none; background: var(--bg-secondary);
            border-radius: 16px; padding: 30px; border: 1px solid var(--border);
        }

        .panel.active { display: block; }

        textarea, input, select {
            width: 100%; padding: 16px; border: 2px solid var(--border);
            border-radius: 12px; font-size: 1rem; font-family: inherit;
            background: var(--bg-card); color: var(--text-primary); resize: vertical;
        }

        textarea:focus, input:focus, select:focus {
            outline: none; border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        textarea::placeholder, input::placeholder { color: var(--text-muted); }

        button {
            padding: 14px 28px; background: var(--accent-blue); color: white;
            border: none; border-radius: 10px; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }

        button:hover {
            background: #2563eb; transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        button:disabled { background: var(--text-muted); cursor: not-allowed; transform: none; box-shadow: none; }

        .examples { margin-top: 20px; }
        .examples h4 { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .example-chips { display: flex; flex-wrap: wrap; gap: 10px; }

        .example-chip {
            padding: 10px 16px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 25px; font-size: 0.9rem; cursor: pointer;
            transition: all 0.2s; color: var(--text-secondary);
        }

        .example-chip:hover {
            background: var(--bg-hover); border-color: var(--accent-blue); color: var(--text-primary);
        }

        .answer-box { margin-top: 30px; display: none; }
        .answer-box.visible { display: block; }

        .answer-header {
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border);
        }

        .answer-header h3 { font-size: 1.1rem; color: var(--text-primary); }

        .answer-content {
            background: linear-gradient(135deg, var(--bg-card) 0%, #1a1f2e 100%);
            border-radius: 12px; 
            padding: 30px;
            border-left: 4px solid var(--accent-blue); 
            line-height: 1.8;
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        .answer-content h3, .answer-content h4 {
            font-weight: 600;
        }
        
        .answer-content strong {
            font-weight: 700;
        }
        
        .answer-content p {
            margin: 12px 0;
        }

        .sources { margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border); }

        .sources h4 {
            font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px;
            display: flex; align-items: center; gap: 8px;
        }

        .source-item {
            background: var(--bg-card); padding: 15px; border-radius: 10px;
            margin-bottom: 10px; border: 1px solid var(--border);
        }

        .source-title { font-weight: 600; color: var(--accent-blue); margin-bottom: 5px; font-size: 0.95rem; }
        .source-excerpt { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; }

        .upload-zone {
            border: 2px dashed var(--border); border-radius: 16px; padding: 50px;
            text-align: center; transition: all 0.2s; cursor: pointer; background: var(--bg-card);
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.05);
        }

        .upload-zone input[type="file"] { display: none; }
        .upload-icon { font-size: 3.5rem; margin-bottom: 15px; opacity: 0.8; }
        .upload-zone p { color: var(--text-secondary); }
        .upload-zone strong { color: var(--text-primary); }

        .selected-files { margin-top: 25px; display: none; }
        .selected-files.visible { display: block; }

        .file-list { max-height: 200px; overflow-y: auto; margin-bottom: 20px; }

        .file-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; background: var(--bg-card); border-radius: 10px;
            margin-bottom: 8px; border: 1px solid var(--border);
        }

        .file-item .filename {
            font-weight: 500; color: var(--text-primary);
            display: flex; align-items: center; gap: 10px;
        }

        .remove-btn { background: var(--accent-red); padding: 6px 14px; font-size: 0.85rem; }

        .upload-progress { margin-top: 25px; display: none; }
        .upload-progress.visible { display: block; }

        .progress-item {
            padding: 14px 18px; margin-bottom: 10px; border-radius: 10px;
            font-size: 0.95rem; display: flex; align-items: center; gap: 10px;
        }

        .progress-item.processing { background: rgba(245, 158, 11, 0.15); color: var(--accent-yellow); border: 1px solid var(--accent-yellow); }
        .progress-item.success { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); border: 1px solid var(--accent-green); }
        .progress-item.error { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); border: 1px solid var(--accent-red); }
        .progress-item.exists { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); border: 1px solid var(--accent-blue); }

        .guidelines-list { display: flex; flex-direction: column; gap: 15px; }

        .guideline-card {
            padding: 25px; background: var(--bg-card); border-radius: 14px;
            border: 1px solid var(--border); transition: all 0.2s;
        }

        .guideline-card:hover {
            border-color: var(--accent-blue); transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .guideline-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }

        .guideline-info h3 { font-size: 1.15rem; margin-bottom: 8px; color: var(--text-primary); }

        .guideline-meta {
            font-size: 0.85rem; color: var(--text-muted);
            display: flex; flex-wrap: wrap; gap: 20px;
        }

        .guideline-meta span { display: flex; align-items: center; gap: 6px; }

        .guideline-actions { display: flex; gap: 10px; flex-wrap: wrap; }

        .btn-pptx { background: var(--accent-purple); padding: 10px 18px; font-size: 0.9rem; }
        .btn-pptx:hover { background: #7c3aed; }

        .btn-analyze { background: var(--accent-blue); padding: 10px 18px; font-size: 0.9rem; }
        .btn-analyze:hover { background: #2563eb; }

        .btn-topic { background: var(--accent-green); padding: 10px 18px; font-size: 0.9rem; }
        .btn-topic:hover { background: #059669; }

        .btn-delete {
            background: transparent; border: 1px solid var(--accent-red);
            color: var(--accent-red); padding: 10px 18px; font-size: 0.9rem;
        }

        .btn-delete:hover { background: var(--accent-red); color: white; }

        .guideline-sections {
            margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);
            font-size: 0.85rem; color: var(--text-muted); max-height: 60px; overflow: hidden;
        }

        .empty-state { text-align: center; padding: 60px; color: var(--text-muted); }
        .empty-state .icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }

        .loading {
            display: inline-block; width: 20px; height: 20px;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%;
            border-top-color: white; animation: spin 0.8s linear infinite; margin-right: 10px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;
        }

        .modal-overlay.visible { display: flex; }

        .modal {
            background: var(--bg-secondary); border-radius: 16px; padding: 30px;
            max-width: 500px; width: 90%; border: 1px solid var(--border);
        }

        .modal h3 { margin-bottom: 20px; }

        .topic-list {
            display: flex; flex-direction: column; gap: 10px;
            max-height: 300px; overflow-y: auto; margin-bottom: 20px;
        }

        .topic-btn {
            text-align: left; padding: 15px 20px; background: var(--bg-card);
            border: 1px solid var(--border); color: var(--text-primary);
        }

        .topic-btn:hover { border-color: var(--accent-blue); background: var(--bg-hover); }

        .modal-close { background: var(--bg-card); color: var(--text-secondary); width: 100%; }

        @media (max-width: 600px) {
            .tabs { flex-direction: column; }
            .stats-bar { gap: 15px; }
            .stat { padding: 12px 20px; }
            .guideline-header { flex-direction: column; gap: 15px; }
            .guideline-actions { width: 100%; }
            .guideline-actions button { flex: 1; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">ü´Ä</div>
        <h1>Cardiology Guidelines AI</h1>
        <p>Evidence-based answers from ACC, AHA & ESC guidelines</p>
        <div class="stats-bar">
            <div class="stat">
                <span class="stat-value" id="statGuidelines">0</span>
                <span class="stat-label">Guidelines</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="statChunks">0</span>
                <span class="stat-label">Indexed Chunks</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="statPages">0</span>
                <span class="stat-label">Pages</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="ask">üí¨ Ask Question</button>
            <button class="tab" data-tab="upload">üì§ Upload Guidelines</button>
            <button class="tab" data-tab="library">üìö Guidelines Library</button>
        </div>

        <!-- ASK PANEL -->
        <div id="ask" class="panel active">
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <textarea id="question" rows="4" placeholder="Ask any cardiology question...

Example: What are the Class I recommendations for catheter ablation in atrial fibrillation?"></textarea>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <select id="modelSelect" style="flex: 1; max-width: 300px;">
                        <optgroup label="Anthropic Claude">
                            <option value="claude-opus-4-20250514">üß† Opus 4 (Smartest)</option>
                            <option value="claude-sonnet-4-20250514-thinking">ü§î Sonnet 4 Deep Think</option>
                            <option value="claude-sonnet-4-20250514" selected>‚ö° Sonnet 4 (Balanced)</option>
                            <option value="claude-haiku-3-5-20241022">üöÄ Haiku 3.5 (Fastest)</option>
                        </optgroup>
                        <optgroup label="OpenAI">
                            <option value="gpt-5.2">üåü GPT-5.2 (Latest)</option>
                        </optgroup>
                    </select>
                    <button id="askBtn" onclick="askQuestion()" style="flex: 1;">üîç Search Guidelines</button>
                </div>
            </div>

            <div class="examples">
                <h4>Quick Questions</h4>
                <div class="example-chips">
                    <span class="example-chip" onclick="setQuestion('What are the Class I indications for catheter ablation in AFib?')">AFib Ablation</span>
                    <span class="example-chip" onclick="setQuestion('When should I anticoagulate a patient with atrial fibrillation?')">AFib Anticoagulation</span>
                    <span class="example-chip" onclick="setQuestion('What are the guideline-directed medications for HFrEF?')">HFrEF Medications</span>
                    <span class="example-chip" onclick="setQuestion('What is the recommended LDL target for secondary prevention?')">LDL Targets</span>
                    <span class="example-chip" onclick="setQuestion('What are the indications for ICD placement?')">ICD Indications</span>
                </div>
            </div>

            <div id="answerBox" class="answer-box">
                <div class="answer-header">
                    <span style="font-size: 1.5rem;">üìã</span>
                    <h3>Guideline-Based Answer</h3>
                    <div id="usageInfo" style="margin-left: auto; font-size: 0.8rem; color: var(--text-muted); display: flex; gap: 15px;"></div>
                </div>
                <div id="answerContent" class="answer-content"></div>
                <div id="sourcesSection" class="sources">
                    <h4>üìö Sources Referenced</h4>
                    <div id="sourcesList"></div>
                </div>
            </div>
        </div>

        <!-- UPLOAD PANEL -->
        <div id="upload" class="panel">
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="fileInput" accept=".pdf" multiple>
                <div class="upload-icon">üìÑ</div>
                <p><strong>Click to select</strong> or drag & drop PDF files</p>
                <p style="margin-top: 10px; font-size: 0.9rem;">Upload ACC, AHA, ESC, or other cardiology guidelines</p>
            </div>

            <div id="selectedFiles" class="selected-files">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <strong style="font-size: 1.1rem;">üìÅ Selected Files (<span id="fileCount">0</span>)</strong>
                    <button style="background: var(--bg-card); padding: 8px 16px; font-size: 0.85rem;" onclick="clearAllFiles()">Clear All</button>
                </div>
                <div id="fileList" class="file-list"></div>
                <button id="uploadBtn" onclick="uploadFiles()" style="width: 100%;">üì§ Upload & Process All</button>
            </div>

            <div id="uploadProgress" class="upload-progress">
                <strong style="display: block; margin-bottom: 15px;">‚è≥ Processing...</strong>
                <div id="progressList"></div>
            </div>
        </div>

        <!-- LIBRARY PANEL -->
        <div id="library" class="panel">
            <div id="guidelinesList" class="guidelines-list">
                <div class="empty-state">
                    <div class="icon">üìö</div>
                    <p>Loading guidelines...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PPTX Generation Modal -->
    <div class="modal-overlay" id="pptxModal">
        <div class="modal" style="max-width: 500px;">
            <h3 id="pptxModalTitle">üìä Generate Presentation</h3>
            
            <div style="margin-bottom: 20px;">
                <label style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 8px;">Select AI Model:</label>
                <select id="pptxModelSelect" style="width: 100%; padding: 12px; font-size: 0.95rem;">
                    <option value="claude-sonnet-4-20250514">‚ö° Sonnet 4 - Fast (~$0.02)</option>
                    <option value="claude-sonnet-4-20250514-thinking">ü§î Sonnet 4 Deep Think (~$0.08)</option>
                    <option value="claude-opus-4-20250514">üß† Opus 4 - Best (~$0.15)</option>
                    <option value="gpt-5.2">üåü GPT-5.2 (~$0.03)</option>
                </select>
            </div>
            
            <div id="topicSection" style="margin-bottom: 20px;">
                <label style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 8px;">Select Topic (or Full for everything):</label>
                <div class="topic-list" id="topicList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div style="grid-column: span 2; text-align: center; padding: 20px; color: var(--text-muted);">
                        <span class="loading" style="width: 24px; height: 24px; display: inline-block;"></span>
                        <p style="margin-top: 10px;">Analyzing guideline topics...</p>
                    </div>
                </div>
            </div>
            
            <button class="modal-close" onclick="closePPTXModal()">Cancel</button>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let selectedFiles = [];
        let currentGuidelineId = null;
        let currentGuidelineName = '';
        let currentSelectedTopic = null;

        loadStats();

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                if (tab.dataset.tab === 'library') loadGuidelines();
            });
        });

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/api/stats`);
                const stats = await response.json();
                document.getElementById('statGuidelines').textContent = stats.total_guidelines || 0;
                document.getElementById('statChunks').textContent = stats.total_chunks || 0;
                document.getElementById('statPages').textContent = stats.total_pages || 0;
            } catch (e) { console.error('Error loading stats:', e); }
        }

        function setQuestion(q) { document.getElementById('question').value = q; }
        
        // Store current question for highlighting
        let currentSearchQuestion = '';
        let sourceZoomLevel = 1.0;
        
        // Extract important keywords from question (skip common words)
        function getKeywords(question) {
            const stopWords = ['what', 'is', 'the', 'a', 'an', 'for', 'to', 'of', 'in', 'on', 'at', 'and', 'or', 'are', 'how', 'when', 'where', 'which', 'who', 'why', 'does', 'do', 'should', 'would', 'could', 'can', 'will', 'be', 'been', 'being', 'have', 'has', 'had', 'with', 'from', 'this', 'that', 'these', 'those', 'it', 'its', 'my', 'your', 'their', 'our', 'i', 'you', 'we', 'they', 'about', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'between', 'under', 'over', 'again', 'further', 'then', 'once', 'there', 'here', 'all', 'any', 'both', 'each', 'few', 'more', 'most', 'other', 'some', 'such', 'only', 'same', 'so', 'than', 'too', 'very', 'just', 'but', 'if', 'because', 'as', 'until', 'while', 'per', 'vs', 'versus'];
            
            return question.toLowerCase()
                .replace(/[^\w\s]/g, ' ')
                .split(/\s+/)
                .filter(word => word.length > 2 && !stopWords.includes(word));
        }
        
        // Highlight keywords in text
        function highlightText(text, keywords) {
            if (!keywords || keywords.length === 0) return text;
            
            let result = text;
            keywords.forEach(keyword => {
                const regex = new RegExp(`(${keyword})`, 'gi');
                result = result.replace(regex, '<mark style="background: #fbbf24; color: #000; padding: 1px 3px; border-radius: 3px; font-weight: 500;">$1</mark>');
            });
            
            // Also highlight Class I/IIa/IIb/III
            result = result
                .replace(/\b(Class I)([^Ia])/gi, '<span style="background: rgba(34, 197, 94, 0.3); color: #22c55e; padding: 2px 4px; border-radius: 3px; font-weight: 600;">$1</span>$2')
                .replace(/\b(Class IIa)\b/gi, '<span style="background: rgba(59, 130, 246, 0.3); color: #3b82f6; padding: 2px 4px; border-radius: 3px; font-weight: 600;">$1</span>')
                .replace(/\b(Class IIb)\b/gi, '<span style="background: rgba(251, 191, 36, 0.3); color: #fbbf24; padding: 2px 4px; border-radius: 3px; font-weight: 600;">$1</span>')
                .replace(/\b(Class III)\b/gi, '<span style="background: rgba(239, 68, 68, 0.3); color: #ef4444; padding: 2px 4px; border-radius: 3px; font-weight: 600;">$1</span>');
            
            return result;
        }
        
        // Zoom controls for source text
        function zoomSource(idx, delta) {
            sourceZoomLevel = Math.max(0.7, Math.min(1.5, sourceZoomLevel + delta));
            const textDiv = document.getElementById(`source-text-${idx}`);
            if (textDiv) {
                textDiv.style.fontSize = `${0.9 * sourceZoomLevel}rem`;
                textDiv.style.lineHeight = `${1.8 * sourceZoomLevel}`;
            }
            document.getElementById(`zoom-level-${idx}`).textContent = Math.round(sourceZoomLevel * 100) + '%';
        }
        
        // Zoom controls for PDF page images
        let pageImageZoomLevels = {};
        function zoomPageImage(idx, delta) {
            if (!pageImageZoomLevels[idx]) pageImageZoomLevels[idx] = 1.0;
            pageImageZoomLevels[idx] = Math.max(0.5, Math.min(3.0, pageImageZoomLevels[idx] + delta));
            const img = document.getElementById(`page-img-${idx}`);
            if (img) {
                img.style.transform = `scale(${pageImageZoomLevels[idx]})`;
                img.style.transformOrigin = 'top center';
            }
            const levelSpan = document.getElementById(`img-zoom-level-${idx}`);
            if (levelSpan) {
                levelSpan.textContent = Math.round(pageImageZoomLevels[idx] * 100) + '%';
            }
        }

        async function askQuestion() {
            const question = document.getElementById('question').value.trim();
            const model = document.getElementById('modelSelect').value;
            if (!question) return;
            
            // Store question for highlighting
            currentSearchQuestion = question;

            const btn = document.getElementById('askBtn');
            const answerBox = document.getElementById('answerBox');
            const answerContent = document.getElementById('answerContent');
            const sourcesList = document.getElementById('sourcesList');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>Searching guidelines...';
            answerBox.classList.remove('visible');

            try {
                const response = await fetch(`${API_BASE}/api/ask`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, model })
                });

                const data = await response.json();
                
                // Format the answer with markdown rendering
                answerContent.innerHTML = formatAnswer(data.answer || data.error || 'No answer received');
                
                // Show usage/cost info
                const usageInfo = document.getElementById('usageInfo');
                if (data.usage) {
                    usageInfo.innerHTML = `
                        <span>ü§ñ ${data.model || 'Unknown'}</span>
                        <span>üìä ${data.usage.total_tokens.toLocaleString()} tokens</span>
                        <span style="color: var(--accent-green);">üí∞ $${data.usage.cost_usd.toFixed(4)}</span>
                    `;
                } else {
                    usageInfo.innerHTML = '';
                }
                
                sourcesList.innerHTML = '';
                if (data.sources && data.sources.length > 0) {
                    data.sources.forEach((source, idx) => {
                        const div = document.createElement('div');
                        div.className = 'source-item';
                        div.innerHTML = `
                            <div class="source-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 8px;">
                                <div>
                                    <div class="source-title">${source.guideline}${source.year ? ` (${source.year})` : ''}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
                                        üìÑ Page ${source.page || '?'} ‚Ä¢ üìã ${source.covers || 'Clinical content'}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${source.page && source.guideline_id ? `
                                        <button class="source-toggle" onclick="showPageImage(${source.guideline_id}, ${source.page}, '${source.guideline.replace(/'/g, "\\'")}', ${idx})" style="background: var(--accent-green); padding: 6px 14px; font-size: 0.8rem; border-radius: 6px;">
                                            üì∏ View Page
                                        </button>
                                    ` : ''}
                                    <button class="source-toggle" id="toggle-btn-${idx}" onclick="toggleSource(${idx})" style="background: var(--accent-blue); padding: 6px 14px; font-size: 0.8rem; border-radius: 6px; min-width: 110px;">
                                        üìÑ Show Text
                                    </button>
                                </div>
                            </div>
                            <div class="source-page-image" id="page-image-${idx}" style="display: none; margin-top: 12px; text-align: center;">
                                <div style="background: var(--bg-primary); padding: 15px; border-radius: 10px; border: 1px solid var(--accent-green);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
                                        <span style="color: var(--text-secondary); font-size: 0.8rem;">üìÑ PDF Page ${source.page}</span>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <button onclick="zoomPageImage(${idx}, -0.2)" style="background: var(--bg-card); border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">üîç‚àí</button>
                                            <span id="img-zoom-level-${idx}" style="font-size: 0.75rem; color: var(--text-muted); min-width: 40px; text-align: center;">100%</span>
                                            <button onclick="zoomPageImage(${idx}, 0.2)" style="background: var(--bg-card); border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">üîç+</button>
                                        </div>
                                    </div>
                                    <div style="overflow: auto; max-height: 600px;">
                                        <img id="page-img-${idx}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); transition: transform 0.2s;" />
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <button onclick="document.getElementById('page-image-${idx}').style.display='none'" style="background: var(--bg-card); padding: 8px 20px;">Close Image</button>
                                    </div>
                                </div>
                            </div>
                            <div class="source-full" id="source-full-${idx}" style="display: none; margin-top: 12px; padding: 20px; background: linear-gradient(135deg, var(--bg-primary) 0%, #1a2332 100%); border-radius: 10px; max-height: 450px; overflow-y: auto; border: 1px solid var(--accent-blue); box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
                                    <div style="color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">üìã Original Guideline Text</div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <button onclick="zoomSource(${idx}, -0.1)" style="background: var(--bg-card); border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">üîç‚àí</button>
                                        <span id="zoom-level-${idx}" style="font-size: 0.75rem; color: var(--text-muted); min-width: 40px; text-align: center;">100%</span>
                                        <button onclick="zoomSource(${idx}, 0.1)" style="background: var(--bg-card); border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">üîç+</button>
                                    </div>
                                </div>
                                <div id="source-text-${idx}" style="color: var(--text-primary); font-size: 0.9rem; line-height: 1.8;">${highlightText(cleanPdfText(source.full_text || source.excerpt), getKeywords(currentSearchQuestion))}</div>
                            </div>
                        `;
                        sourcesList.appendChild(div);
                    });
                }

                answerBox.classList.add('visible');
            } catch (error) {
                answerContent.textContent = 'Error: ' + error.message;
                answerBox.classList.add('visible');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîç Search Guidelines';
            }
        }

        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => { uploadZone.classList.remove('dragover'); });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            addFiles(Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf'));
        });
        fileInput.addEventListener('change', (e) => { addFiles(Array.from(e.target.files)); });

        function addFiles(files) {
            files.forEach(file => {
                if (!selectedFiles.find(f => f.name === file.name)) selectedFiles.push(file);
            });
            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const fileCount = document.getElementById('fileCount');
            const selectedFilesDiv = document.getElementById('selectedFiles');

            if (selectedFiles.length === 0) { selectedFilesDiv.classList.remove('visible'); return; }

            selectedFilesDiv.classList.add('visible');
            fileCount.textContent = selectedFiles.length;

            fileList.innerHTML = selectedFiles.map((file, index) => `
                <div class="file-item">
                    <span class="filename">üìÑ ${file.name}</span>
                    <button class="remove-btn" onclick="removeFile(${index})">Remove</button>
                </div>
            `).join('');
        }

        function removeFile(index) { selectedFiles.splice(index, 1); updateFileList(); }

        function clearAllFiles() {
            selectedFiles = [];
            fileInput.value = '';
            updateFileList();
            document.getElementById('uploadProgress').classList.remove('visible');
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            const btn = document.getElementById('uploadBtn');
            const progressDiv = document.getElementById('uploadProgress');
            const progressList = document.getElementById('progressList');

            btn.disabled = true;
            progressDiv.classList.add('visible');
            
            // Show all files as pending
            progressList.innerHTML = selectedFiles.map((f, i) => 
                `<div class="progress-item" style="background: var(--bg-card); color: var(--text-muted); border: 1px solid var(--border);" id="progress-${f.name.replace(/[^a-z0-9]/gi, '_')}">‚è∏Ô∏è Queued: ${f.name}</div>`
            ).join('');

            let successCount = 0;
            let failCount = 0;

            // Process files ONE AT A TIME
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const id = `progress-${file.name.replace(/[^a-z0-9]/gi, '_')}`;
                const el = document.getElementById(id);
                
                // Update button to show progress
                btn.innerHTML = `<span class="loading"></span>Processing ${i + 1} of ${selectedFiles.length}...`;
                
                // Mark current file as processing
                if (el) {
                    el.className = 'progress-item processing';
                    el.innerHTML = `‚è≥ Processing (${i + 1}/${selectedFiles.length}): ${file.name}`;
                }

                // Upload single file
                const formData = new FormData();
                formData.append('files', file);

                try {
                    const response = await fetch(`${API_BASE}/api/upload`, { 
                        method: 'POST', 
                        body: formData 
                    });
                    
                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error(`Server error (${response.status})`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.results && data.results[0]) {
                        const result = data.results[0];
                        if (el) {
                            if (result.status === 'success') {
                                el.className = 'progress-item success';
                                el.innerHTML = `‚úÖ ${file.name}: ${result.pages} pages, ${result.chunks} chunks indexed`;
                                successCount++;
                            } else if (result.status === 'exists') {
                                el.className = 'progress-item exists';
                                el.innerHTML = `‚ÑπÔ∏è ${file.name}: Already exists in database`;
                                successCount++;
                            } else {
                                el.className = 'progress-item error';
                                el.innerHTML = `‚ùå ${file.name}: ${result.message || 'Unknown error'}`;
                                failCount++;
                            }
                        }
                    } else if (data.error) {
                        if (el) {
                            el.className = 'progress-item error';
                            el.innerHTML = `‚ùå ${file.name}: ${data.error}`;
                        }
                        failCount++;
                    }
                } catch (error) {
                    if (el) {
                        el.className = 'progress-item error';
                        el.innerHTML = `‚ùå ${file.name}: ${error.message}`;
                    }
                    failCount++;
                }
            }

            // Done - show summary
            selectedFiles = [];
            updateFileList();
            loadStats();
            
            btn.disabled = false;
            btn.innerHTML = 'üì§ Upload & Process All';
            
            // Add summary at top
            const summary = document.createElement('div');
            summary.className = `progress-item ${failCount === 0 ? 'success' : 'exists'}`;
            summary.innerHTML = `üìä Complete: ${successCount} succeeded, ${failCount} failed`;
            progressList.insertBefore(summary, progressList.firstChild);
        }

        async function loadGuidelines() {
            const list = document.getElementById('guidelinesList');
            
            try {
                const response = await fetch(`${API_BASE}/api/guidelines`);
                const data = await response.json();

                if (!data.guidelines || data.guidelines.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üì≠</div>
                            <p>No guidelines uploaded yet</p>
                            <p style="margin-top: 10px; font-size: 0.9rem;">Go to "Upload Guidelines" to add PDFs</p>
                        </div>`;
                    return;
                }

                list.innerHTML = data.guidelines.map(g => `
                    <div class="guideline-card" id="guideline-card-${g.id}">
                        <div class="guideline-header">
                            <div class="guideline-info">
                                <h3>üìã ${g.name}</h3>
                                <div class="guideline-meta">
                                    ${g.year ? `<span>üìÖ ${g.year}</span>` : ''}
                                    ${g.source ? `<span>üèõÔ∏è ${g.source}</span>` : ''}
                                    <span>üìÑ ${g.page_count || '?'} pages</span>
                                    <span>üß© ${g.chunk_count} chunks</span>
                                    ${g.file_size_mb ? `<span>üíæ ${g.file_size_mb} MB</span>` : ''}
                                </div>
                            </div>
                            <div class="guideline-actions">
                                <button class="btn-analyze" onclick="analyzeTopics(${g.id}, '${g.name.replace(/'/g, "\\'")}')">üîç Analyze Topics</button>
                                <button class="btn-pptx" onclick="openPPTXModal(${g.id}, '${g.name.replace(/'/g, "\\'")}')">üìä Generate PPTX</button>
                                <button class="btn-delete" onclick="deleteGuideline(${g.id}, '${g.name.replace(/'/g, "\\'")}')">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                        <div class="guideline-topics" id="topics-${g.id}" style="margin-top: 10px; display: none;">
                            <!-- Topics will be loaded here -->
                        </div>
                    </div>
                `).join('');
                
                // Load topics for each guideline
                data.guidelines.forEach(g => loadTopicsForGuideline(g.id));
                
            } catch (error) {
                list.innerHTML = `<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Error loading guidelines: ${error.message}</p></div>`;
            }
        }
        
        async function loadTopicsForGuideline(guidelineId) {
            try {
                const response = await fetch(`${API_BASE}/api/topics/${guidelineId}`);
                const data = await response.json();
                
                const container = document.getElementById(`topics-${guidelineId}`);
                if (!container) return;
                
                if (data.analyzed && data.topics && data.topics.length > 0) {
                    container.style.display = 'block';
                    container.innerHTML = `
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">üìö Topics (click to generate PPTX):</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${data.topics.map(t => `
                                <button class="topic-chip" onclick="generateTopicPPTX(${guidelineId}, '${t.topic.replace(/'/g, "\\'")}', '${t.icon}')" 
                                    style="background: var(--bg-primary); border: 1px solid var(--border); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;"
                                    onmouseover="this.style.borderColor='var(--accent-blue)'; this.style.background='var(--bg-card)'"
                                    onmouseout="this.style.borderColor='var(--border)'; this.style.background='var(--bg-primary)'">
                                    ${t.icon} ${t.topic}
                                    ${t.start_page ? `<span style="color: var(--text-muted); font-size: 0.75rem; margin-left: 4px;">(p${t.start_page}-${t.end_page})</span>` : ''}
                                </button>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading topics:', error);
            }
        }
        
        async function analyzeTopics(guidelineId, guidelineName) {
            // Show model selector modal first
            const modelModal = document.createElement('div');
            modelModal.id = 'topicAnalysisModal';
            modelModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:2000;';
            modelModal.innerHTML = `
                <div style="background:var(--bg-card);padding:30px;border-radius:16px;max-width:400px;width:90%;">
                    <h3 style="margin-bottom:20px;">üîç Analyze Topics: ${guidelineName}</h3>
                    <label style="display:block;margin-bottom:10px;color:var(--text-secondary);font-size:0.9rem;">Select AI Model:</label>
                    <select id="topicAnalysisModel" style="width:100%;padding:12px;margin-bottom:20px;font-size:1rem;border-radius:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);">
                        <option value="claude-sonnet-4-20250514">‚ö° Sonnet 4 - Fast & Cheap</option>
                        <option value="claude-opus-4-20250514">üß† Opus 4 - Most Thorough</option>
                    </select>
                    <div style="display:flex;gap:10px;">
                        <button onclick="document.getElementById('topicAnalysisModal').remove()" style="flex:1;padding:12px;background:var(--bg-primary);border:1px solid var(--border);">Cancel</button>
                        <button onclick="runTopicAnalysis(${guidelineId}, '${guidelineName.replace(/'/g, "\\'")}')" style="flex:1;padding:12px;background:var(--accent-blue);">Analyze</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modelModal);
        }
        
        async function runTopicAnalysis(guidelineId, guidelineName) {
            const model = document.getElementById('topicAnalysisModel').value;
            const modal = document.getElementById('topicAnalysisModal');
            
            // Update modal to show loading
            modal.innerHTML = `
                <div style="background:var(--bg-card);padding:40px;border-radius:16px;text-align:center;">
                    <span class="loading" style="width: 40px; height: 40px; margin-bottom: 20px;"></span>
                    <h3 style="margin-bottom:10px;">Analyzing Topics...</h3>
                    <p style="color:var(--text-secondary);">Using: ${model.includes('opus') ? 'Opus 4' : 'Sonnet 4'}</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/api/analyze-topics/${guidelineId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: model })
                });
                const data = await response.json();
                
                modal.remove();
                
                if (data.success) {
                    // Reload topics display
                    loadTopicsForGuideline(guidelineId);
                    // Show success briefly
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = 'position:fixed;top:20px;right:20px;background:var(--accent-green);color:white;padding:15px 25px;border-radius:10px;z-index:2000;';
                    successDiv.textContent = `‚úÖ Found ${data.topics?.length || 0} topics!`;
                    document.body.appendChild(successDiv);
                    setTimeout(() => successDiv.remove(), 3000);
                } else {
                    alert('Error: ' + (data.error || 'Failed to analyze topics'));
                }
            } catch (error) {
                modal.remove();
                alert('Error: ' + error.message);
            }
        }
        
        async function generateTopicPPTX(guidelineId, topicName, icon) {
            // Show a quick model selector before generating
            currentGuidelineId = guidelineId;
            currentGuidelineName = topicName;
            currentSelectedTopic = topicName;
            
            // Create model selection modal
            const modelModal = document.createElement('div');
            modelModal.id = 'modelSelectModal';
            modelModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:2000;';
            modelModal.innerHTML = `
                <div style="background:var(--bg-card);padding:30px;border-radius:16px;max-width:400px;width:90%;">
                    <h3 style="margin-bottom:20px;">${icon} Generate: ${topicName}</h3>
                    <label style="display:block;margin-bottom:10px;color:var(--text-secondary);font-size:0.9rem;">Select AI Model:</label>
                    <select id="topicModelSelect" style="width:100%;padding:12px;margin-bottom:20px;font-size:1rem;border-radius:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);">
                        <option value="claude-sonnet-4-20250514">‚ö° Sonnet 4 - Fast (~$0.02/batch)</option>
                        <option value="claude-sonnet-4-20250514-thinking">ü§î Sonnet 4 Deep Think (~$0.08/batch)</option>
                        <option value="claude-opus-4-20250514">üß† Opus 4 - Best (~$0.15/batch)</option>
                        <option value="gpt-5.2">üåü GPT-5.2 (~$0.03/batch)</option>
                    </select>
                    <div style="display:flex;gap:10px;">
                        <button onclick="document.getElementById('modelSelectModal').remove()" style="flex:1;padding:12px;background:var(--bg-primary);border:1px solid var(--border);">Cancel</button>
                        <button onclick="startTopicPPTX('${topicName.replace(/'/g, "\\'")}', '${icon}')" style="flex:1;padding:12px;background:var(--accent-green);">Generate PPTX</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modelModal);
        }
        
        async function startTopicPPTX(topicName, icon) {
            const model = document.getElementById('topicModelSelect').value;
            document.getElementById('modelSelectModal').remove();
            
            const guidelineId = currentGuidelineId;
            
            // Show loading with progress
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'pptxLoading';
            loadingDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:2000;';
            loadingDiv.innerHTML = `
                <div style="text-align:center;color:white;max-width:450px;padding:30px;">
                    <span class="loading" style="width:50px;height:50px;border-width:4px;margin:0 auto 20px;display:block;"></span>
                    <h3 style="margin-bottom:10px;">${icon} Generating ${topicName} PPTX</h3>
                    <p style="color:#888;font-size:0.9rem;">Using: ${model}</p>
                    <div id="jobProgress" style="margin-top:20px;">
                        <div style="background:#333;border-radius:10px;height:8px;overflow:hidden;margin-bottom:10px;">
                            <div id="progressBar" style="background:var(--accent-blue);height:100%;width:0%;transition:width 0.3s;"></div>
                        </div>
                        <p id="progressText" style="color:#666;font-size:0.8rem;">Starting extraction...</p>
                    </div>
                    <button onclick="document.getElementById('pptxLoading').remove()" style="margin-top:20px;padding:10px 30px;background:#444;border:none;color:white;border-radius:8px;cursor:pointer;">Cancel</button>
                </div>
            `;
            document.body.appendChild(loadingDiv);
            
            try {
                // Start job
                const startResponse = await fetch(`${API_BASE}/api/generate-pptx/${guidelineId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: topicName, model: model })
                });
                
                const jobData = await startResponse.json();
                
                if (!jobData.job_id) {
                    throw new Error(jobData.error || 'Failed to start job');
                }
                
                const jobId = jobData.job_id;
                const totalBatches = jobData.total_batches;
                
                document.getElementById('progressText').textContent = `Batch 0 of ${totalBatches}`;
                
                // Poll for completion
                let completed = false;
                while (!completed) {
                    await new Promise(r => setTimeout(r, 2000)); // Poll every 2 seconds
                    
                    const statusResponse = await fetch(`${API_BASE}/api/pptx-job/${jobId}`);
                    const status = await statusResponse.json();
                    
                    // Update progress
                    const progress = status.progress || 0;
                    const percent = totalBatches > 0 ? (progress / totalBatches) * 100 : 0;
                    document.getElementById('progressBar').style.width = percent + '%';
                    document.getElementById('progressText').textContent = `Batch ${progress} of ${totalBatches}`;
                    
                    if (status.status === 'completed') {
                        completed = true;
                        
                        // Download the file
                        const downloadResponse = await fetch(`${API_BASE}/api/pptx-job/${jobId}/download`);
                        
                        if (downloadResponse.ok) {
                            const cost = status.cost ? status.cost.toFixed(4) : '?';
                            const tokens = status.tokens || '?';
                            
                            const blob = await downloadResponse.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${topicName.replace(/[^a-z0-9]/gi, '_')}.pptx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                            
                            document.getElementById('pptxLoading').innerHTML = `
                                <div style="text-align:center;color:white;background:var(--bg-card);padding:40px;border-radius:16px;border:2px solid var(--accent-green);max-width:450px;">
                                    <div style="font-size:3rem;margin-bottom:15px;">‚úÖ</div>
                                    <h3 style="margin-bottom:20px;color:var(--accent-green);">${icon} ${topicName} Ready!</h3>
                                    <p style="color:var(--text-secondary);margin-bottom:15px;">Model: ${model}</p>
                                    <div style="display:flex;gap:15px;justify-content:center;margin-bottom:20px;">
                                        <div style="background:var(--bg-primary);padding:12px 20px;border-radius:8px;">
                                            <p style="color:var(--text-secondary);font-size:0.75rem;">COST</p>
                                            <p style="color:var(--accent-green);font-size:1.2rem;font-weight:700;">$${cost}</p>
                                        </div>
                                        <div style="background:var(--bg-primary);padding:12px 20px;border-radius:8px;">
                                            <p style="color:var(--text-secondary);font-size:0.75rem;">TOKENS</p>
                                            <p style="color:var(--accent-blue);font-size:1.2rem;font-weight:700;">${parseInt(tokens).toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <div style="display:flex;gap:10px;margin-bottom:15px;">
                                        <a href="${API_BASE}/api/pptx-job/${jobId}/download" style="flex:1;padding:12px;background:var(--accent-purple);color:white;text-decoration:none;border-radius:8px;text-align:center;font-weight:600;">üìä Download PPTX</a>
                                        <a href="${API_BASE}/api/pptx-job/${jobId}/download-html" style="flex:1;padding:12px;background:var(--accent-blue);color:white;text-decoration:none;border-radius:8px;text-align:center;font-weight:600;">üåê Download HTML</a>
                                    </div>
                                    <button onclick="document.getElementById('pptxLoading').remove()" style="padding:12px 40px;font-size:1rem;width:100%;">Close</button>
                                </div>
                            `;
                        } else {
                            throw new Error('Failed to download PPTX');
                        }
                    } else if (status.status === 'failed') {
                        completed = true;
                        // Show detailed error modal
                        document.getElementById('pptxLoading').innerHTML = `
                            <div style="text-align:center;color:white;background:var(--bg-card);padding:40px;border-radius:16px;border:2px solid var(--accent-red);max-width:500px;">
                                <div style="font-size:3rem;margin-bottom:15px;">‚ùå</div>
                                <h3 style="margin-bottom:20px;color:var(--accent-red);">Extraction Failed</h3>
                                <div style="background:var(--bg-primary);padding:15px;border-radius:8px;margin-bottom:20px;text-align:left;max-height:200px;overflow-y:auto;">
                                    <p style="color:var(--text-secondary);font-size:0.8rem;margin-bottom:8px;">ERROR DETAILS:</p>
                                    <p style="color:var(--accent-red);font-size:0.9rem;word-break:break-word;">${status.error || 'Unknown error - check server logs'}</p>
                                </div>
                                <div style="background:var(--bg-primary);padding:15px;border-radius:8px;margin-bottom:20px;text-align:left;">
                                    <p style="color:var(--text-secondary);font-size:0.8rem;margin-bottom:8px;">JOB INFO:</p>
                                    <p style="color:var(--text-muted);font-size:0.85rem;">Job ID: ${jobId} | Model: ${model}</p>
                                    <p style="color:var(--text-muted);font-size:0.85rem;">Progress: Batch ${status.progress || 0} of ${totalBatches}</p>
                                </div>
                                <button onclick="document.getElementById('pptxLoading').remove()" style="padding:12px 40px;font-size:1rem;width:100%;">Close</button>
                            </div>
                        `;
                    }
                    // else still processing, continue polling
                }
                
            } catch (error) {
                // Show error in modal instead of alert
                const loadingEl = document.getElementById('pptxLoading');
                if (loadingEl) {
                    loadingEl.innerHTML = `
                        <div style="text-align:center;color:white;background:var(--bg-card);padding:40px;border-radius:16px;border:2px solid var(--accent-red);max-width:500px;">
                            <div style="font-size:3rem;margin-bottom:15px;">‚ùå</div>
                            <h3 style="margin-bottom:20px;color:var(--accent-red);">Error</h3>
                            <p style="color:var(--accent-red);margin-bottom:20px;">${error.message}</p>
                            <button onclick="document.getElementById('pptxLoading').remove()" style="padding:12px 40px;font-size:1rem;">Close</button>
                        </div>
                    `;
                } else {
                    alert('Error: ' + error.message);
                }
            }
        }

        async function deleteGuideline(id, name) {
            if (!confirm(`Delete "${name}"?\n\nThis will remove the guideline and all its indexed content.`)) return;
            try {
                await fetch(`${API_BASE}/api/delete/${id}`, { method: 'DELETE' });
                loadGuidelines();
                loadStats();
            } catch (error) { alert('Error deleting: ' + error.message); }
        }

        async function openPPTXModal(guidelineId, guidelineName) {
            currentGuidelineId = guidelineId;
            currentGuidelineName = guidelineName;
            document.getElementById('pptxModalTitle').textContent = `üìä Generate PPTX: ${guidelineName}`;
            document.getElementById('pptxModal').classList.add('visible');
            
            // Show loading state
            const topicList = document.getElementById('topicList');
            topicList.innerHTML = `
                <div style="grid-column: span 2; text-align: center; padding: 20px; color: var(--text-muted);">
                    <span class="loading" style="width: 24px; height: 24px; display: inline-block;"></span>
                    <p style="margin-top: 10px;">Analyzing guideline topics...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/api/topics/${guidelineId}`);
                const data = await response.json();
                
                // Build topic buttons
                let html = `<button class="topic-btn" onclick="startPPTXGeneration(null)" style="grid-column: span 2; background: var(--accent-green);">üìã FULL Guideline (All Recommendations)</button>`;
                
                if (data.topics && data.topics.length > 0) {
                    data.topics.forEach(t => {
                        const icon = t.icon || 'üìã';
                        const topic = t.topic || t;
                        html += `<button class="topic-btn" onclick="startPPTXGeneration('${topic.replace(/'/g, "\\'")}')">${icon} ${topic}</button>`;
                    });
                } else {
                    html += `<div style="grid-column: span 2; text-align: center; padding: 15px; color: var(--text-muted); font-size: 0.9rem;">
                        No specific topics detected. Use "Full Guideline" above.
                    </div>`;
                }
                
                topicList.innerHTML = html;
                
            } catch (error) {
                console.error('Topic fetch error:', error);
                topicList.innerHTML = `
                    <button class="topic-btn" onclick="startPPTXGeneration(null)" style="grid-column: span 2; background: var(--accent-green);">üìã FULL Guideline (All Recommendations)</button>
                    <div style="grid-column: span 2; text-align: center; padding: 10px; color: var(--text-muted); font-size: 0.85rem;">
                        Could not analyze topics. Use Full Guideline.
                    </div>
                `;
            }
        }

        function closePPTXModal() {
            document.getElementById('pptxModal').classList.remove('visible');
            currentGuidelineId = null;
            currentGuidelineName = '';
        }

        async function startPPTXGeneration(topic) {
            const guidelineId = currentGuidelineId;
            const guidelineName = currentGuidelineName;
            const model = document.getElementById('pptxModelSelect').value;
            closePPTXModal();
            
            if (!guidelineId) {
                alert('Error: No guideline selected');
                return;
            }
            
            const topicLabel = topic || 'Full Guideline';
            
            // Show loading with progress
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'pptxLoading';
            loadingDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:2000;';
            loadingDiv.innerHTML = `
                <div style="text-align:center;color:white;max-width:450px;padding:30px;">
                    <span class="loading" style="width:50px;height:50px;border-width:4px;margin:0 auto 20px;display:block;"></span>
                    <h3 style="margin-bottom:10px;">üìä Generating ${topicLabel} PPTX</h3>
                    <p style="color:#888;font-size:0.9rem;">Using: ${model}</p>
                    <div id="jobProgress" style="margin-top:20px;">
                        <div style="background:#333;border-radius:10px;height:8px;overflow:hidden;margin-bottom:10px;">
                            <div id="progressBar" style="background:var(--accent-blue);height:100%;width:0%;transition:width 0.3s;"></div>
                        </div>
                        <p id="progressText" style="color:#666;font-size:0.8rem;">Starting...</p>
                    </div>
                    <button onclick="document.getElementById('pptxLoading').remove()" style="margin-top:20px;padding:10px 30px;background:#444;border:none;color:white;border-radius:8px;cursor:pointer;">Cancel</button>
                </div>
            `;
            document.body.appendChild(loadingDiv);
            
            try {
                // Start job
                const startResponse = await fetch(`${API_BASE}/api/generate-pptx/${guidelineId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, model })
                });
                
                const jobData = await startResponse.json();
                
                if (!jobData.job_id) {
                    throw new Error(jobData.error || 'Failed to start job');
                }
                
                const jobId = jobData.job_id;
                const totalBatches = jobData.total_batches;
                
                document.getElementById('progressText').textContent = `Batch 0 of ${totalBatches}`;
                
                // Poll for completion
                let completed = false;
                while (!completed) {
                    await new Promise(r => setTimeout(r, 2000));
                    
                    const statusResponse = await fetch(`${API_BASE}/api/pptx-job/${jobId}`);
                    const status = await statusResponse.json();
                    
                    const progress = status.progress || 0;
                    const percent = totalBatches > 0 ? (progress / totalBatches) * 100 : 0;
                    document.getElementById('progressBar').style.width = percent + '%';
                    document.getElementById('progressText').textContent = `Batch ${progress} of ${totalBatches}`;
                    
                    if (status.status === 'completed') {
                        completed = true;
                        
                        const downloadResponse = await fetch(`${API_BASE}/api/pptx-job/${jobId}/download`);
                        
                        if (downloadResponse.ok) {
                            const cost = status.cost ? status.cost.toFixed(4) : '?';
                            const tokens = status.tokens || '?';
                            
                            const blob = await downloadResponse.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${guidelineName.replace(/[^a-z0-9]/gi, '_')}${topic ? '_' + topic : ''}.pptx`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                            
                            document.getElementById('pptxLoading').innerHTML = `
                                <div style="text-align:center;color:white;background:var(--bg-card);padding:40px;border-radius:16px;border:2px solid var(--accent-green);max-width:450px;">
                                    <div style="font-size:3rem;margin-bottom:15px;">‚úÖ</div>
                                    <h3 style="margin-bottom:20px;color:var(--accent-green);">Extraction Complete!</h3>
                                    <div style="background:var(--bg-primary);padding:15px;border-radius:8px;margin-bottom:20px;">
                                        <p style="color:var(--text-secondary);margin-bottom:8px;font-size:0.85rem;">Model Used</p>
                                        <p style="font-weight:600;">${model}</p>
                                    </div>
                                    <div style="display:flex;gap:15px;justify-content:center;margin-bottom:20px;">
                                        <div style="background:var(--bg-primary);padding:12px 20px;border-radius:8px;">
                                            <p style="color:var(--text-secondary);font-size:0.75rem;">COST</p>
                                            <p style="color:var(--accent-green);font-size:1.2rem;font-weight:700;">$${cost}</p>
                                        </div>
                                        <div style="background:var(--bg-primary);padding:12px 20px;border-radius:8px;">
                                            <p style="color:var(--text-secondary);font-size:0.75rem;">TOKENS</p>
                                            <p style="color:var(--accent-blue);font-size:1.2rem;font-weight:700;">${parseInt(tokens).toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <div style="display:flex;gap:10px;margin-bottom:15px;">
                                        <a href="${API_BASE}/api/pptx-job/${jobId}/download" style="flex:1;padding:12px;background:var(--accent-purple);color:white;text-decoration:none;border-radius:8px;text-align:center;font-weight:600;">üìä Download PPTX</a>
                                        <a href="${API_BASE}/api/pptx-job/${jobId}/download-html" style="flex:1;padding:12px;background:var(--accent-blue);color:white;text-decoration:none;border-radius:8px;text-align:center;font-weight:600;">üåê Download HTML</a>
                                    </div>
                                    <button onclick="document.getElementById('pptxLoading').remove()" style="padding:12px 40px;font-size:1rem;width:100%;">Close</button>
                                </div>
                            `;
                        } else {
                            throw new Error('Failed to download PPTX');
                        }
                    } else if (status.status === 'failed') {
                        completed = true;
                        document.getElementById('pptxLoading').innerHTML = `
                            <div style="text-align:center;color:white;background:var(--bg-card);padding:40px;border-radius:16px;border:2px solid var(--accent-red);max-width:500px;">
                                <div style="font-size:3rem;margin-bottom:15px;">‚ùå</div>
                                <h3 style="margin-bottom:20px;color:var(--accent-red);">Extraction Failed</h3>
                                <div style="background:var(--bg-primary);padding:15px;border-radius:8px;margin-bottom:20px;text-align:left;max-height:200px;overflow-y:auto;">
                                    <p style="color:var(--text-secondary);font-size:0.8rem;margin-bottom:8px;">ERROR DETAILS:</p>
                                    <p style="color:var(--accent-red);font-size:0.9rem;word-break:break-word;">${status.error || 'Unknown error - check server logs'}</p>
                                </div>
                                <div style="background:var(--bg-primary);padding:15px;border-radius:8px;margin-bottom:20px;text-align:left;">
                                    <p style="color:var(--text-secondary);font-size:0.8rem;margin-bottom:8px;">JOB INFO:</p>
                                    <p style="color:var(--text-muted);font-size:0.85rem;">Job ID: ${jobId} | Model: ${model}</p>
                                    <p style="color:var(--text-muted);font-size:0.85rem;">Progress: Batch ${status.progress || 0} of ${totalBatches}</p>
                                </div>
                                <button onclick="document.getElementById('pptxLoading').remove()" style="padding:12px 40px;font-size:1rem;width:100%;">Close</button>
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                const loadingEl = document.getElementById('pptxLoading');
                if (loadingEl) {
                    loadingEl.innerHTML = `
                        <div style="text-align:center;color:white;background:var(--bg-card);padding:40px;border-radius:16px;border:2px solid var(--accent-red);max-width:500px;">
                            <div style="font-size:3rem;margin-bottom:15px;">‚ùå</div>
                            <h3 style="margin-bottom:20px;color:var(--accent-red);">Error</h3>
                            <p style="color:var(--accent-red);margin-bottom:20px;">${error.message}</p>
                            <button onclick="document.getElementById('pptxLoading').remove()" style="padding:12px 40px;font-size:1rem;">Close</button>
                        </div>
                    `;
                } else {
                    alert('Error: ' + error.message);
                }
            }
        }

        document.getElementById('question').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); askQuestion(); }
        });

        document.getElementById('pptxModal').addEventListener('click', (e) => {
            if (e.target.id === 'pptxModal') closePPTXModal();
        });

        loadGuidelines();
        
        // Clean up messy PDF text for display
        function cleanPdfText(text) {
            if (!text) return '';
            return text
                // Add space before capital letters that follow lowercase (camelCase fix)
                .replace(/([a-z])([A-Z])/g, '$1 $2')
                // Add space after periods if missing
                .replace(/\.([A-Z])/g, '. $1')
                // Add space after commas if missing  
                .replace(/,([A-Za-z])/g, ', $1')
                // Fix multiple spaces
                .replace(/\s+/g, ' ')
                // Clean up weird characters but keep basic punctuation
                .replace(/[^\x20-\x7E\n.,;:!?()-]/g, ' ')
                // Add paragraph breaks for readability (after periods followed by space and capital)
                .replace(/\. ([A-Z])/g, '.<br><br>$1')
                .trim();
        }
        
        // Format AI answer with markdown-like styling
        function formatAnswer(text) {
            if (!text) return '';
            
            let html = text
                // Escape HTML first
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                
                // Headers (### Header or ## Header)
                .replace(/^### (.+)$/gm, '<h4 style="color: var(--accent-blue); margin: 20px 0 10px 0; font-size: 1.1rem;">$1</h4>')
                .replace(/^## (.+)$/gm, '<h3 style="color: var(--accent-green); margin: 25px 0 12px 0; font-size: 1.2rem; border-bottom: 1px solid var(--border); padding-bottom: 8px;">$1</h3>')
                
                // Bold text **text**
                .replace(/\*\*([^*]+)\*\*/g, '<strong style="color: var(--accent-yellow);">$1</strong>')
                
                // Italic text *text*
                .replace(/\*([^*]+)\*/g, '<em style="color: var(--text-secondary);">$1</em>')
                
                // Bullet points (‚Ä¢ or - at start of line)
                .replace(/^[‚Ä¢\-]\s*(.+)$/gm, '<div style="margin: 8px 0 8px 20px; padding-left: 15px; border-left: 3px solid var(--accent-blue);">$1</div>')
                
                // Numbered lists (1. 2. etc)
                .replace(/^(\d+)\.\s+(.+)$/gm, '<div style="margin: 8px 0 8px 20px;"><span style="color: var(--accent-green); font-weight: bold; margin-right: 8px;">$1.</span>$2</div>')
                
                // Class I/IIa/IIb/III highlighting
                .replace(/Class I([^Ia])/gi, '<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 6px; border-radius: 4px; font-weight: 600;">Class I</span>$1')
                .replace(/Class IIa/gi, '<span style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 2px 6px; border-radius: 4px; font-weight: 600;">Class IIa</span>')
                .replace(/Class IIb/gi, '<span style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; padding: 2px 6px; border-radius: 4px; font-weight: 600;">Class IIb</span>')
                .replace(/Class III/gi, '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 2px 6px; border-radius: 4px; font-weight: 600;">Class III</span>')
                
                // LOE highlighting
                .replace(/\(LOE:\s*([ABC](?:-[A-Z]+)?)\)/gi, '<span style="background: rgba(168, 85, 247, 0.2); color: #a855f7; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem;">(LOE: $1)</span>')
                
                // Line breaks
                .replace(/\n\n/g, '</p><p style="margin: 15px 0; line-height: 1.7;">')
                .replace(/\n/g, '<br>');
            
            return '<p style="margin: 15px 0; line-height: 1.7;">' + html + '</p>';
        }
        
        // Toggle source text visibility
        function toggleSource(idx) {
            const fullDiv = document.getElementById(`source-full-${idx}`);
            const btn = document.getElementById(`toggle-btn-${idx}`);
            if (fullDiv.style.display === 'none') {
                fullDiv.style.display = 'block';
                btn.innerHTML = 'üôà Hide Text';
                btn.style.background = 'var(--accent-purple)';
            } else {
                fullDiv.style.display = 'none';
                btn.innerHTML = 'üìÑ Show Text';
                btn.style.background = 'var(--accent-blue)';
            }
        }
        
        // Show page image from PDF
        async function showPageImage(guidelineId, pageNumber, guidelineName, idx) {
            const container = document.getElementById(`page-image-${idx}`);
            const img = document.getElementById(`page-img-${idx}`);
            
            // Toggle off if already visible
            if (container.style.display === 'block') {
                container.style.display = 'none';
                return;
            }
            
            // Show loading
            container.style.display = 'block';
            img.src = '';
            img.alt = 'Loading...';
            container.querySelector('div').innerHTML = `
                <div style="padding: 40px; color: var(--text-secondary);">
                    <span class="loading" style="width: 30px; height: 30px; display: inline-block;"></span>
                    <p style="margin-top: 15px;">Loading page ${pageNumber}...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/api/page-image/${guidelineId}/${pageNumber}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const imageUrl = URL.createObjectURL(blob);
                    
                    container.querySelector('div').innerHTML = `
                        <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 10px;">
                            üìñ ${guidelineName} - Page ${pageNumber}
                        </div>
                        <img src="${imageUrl}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.4);" />
                        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                            <a href="${imageUrl}" download="${guidelineName.replace(/[^a-z0-9]/gi, '_')}_page_${pageNumber}.png" style="background: var(--accent-blue); padding: 8px 16px; border-radius: 6px; text-decoration: none; color: white; font-size: 0.85rem;">üíæ Download</a>
                            <button onclick="document.getElementById('page-image-${idx}').style.display='none'" style="background: var(--bg-card); padding: 8px 16px; font-size: 0.85rem;">Close</button>
                        </div>
                    `;
                } else {
                    const error = await response.json();
                    container.querySelector('div').innerHTML = `
                        <div style="padding: 20px; color: var(--accent-red);">
                            ‚ö†Ô∏è ${error.error || 'Failed to load page image'}
                            <br><small style="color: var(--text-muted);">PDF may need to be re-uploaded to enable page images</small>
                        </div>
                        <button onclick="document.getElementById('page-image-${idx}').style.display='none'" style="margin-top: 10px; background: var(--bg-card); padding: 8px 16px;">Close</button>
                    `;
                }
            } catch (error) {
                container.querySelector('div').innerHTML = `
                    <div style="padding: 20px; color: var(--accent-red);">
                        ‚ö†Ô∏è Error: ${error.message}
                    </div>
                    <button onclick="document.getElementById('page-image-${idx}').style.display='none'" style="margin-top: 10px; background: var(--bg-card); padding: 8px 16px;">Close</button>
                `;
            }
        }
    </script>
</body>
</html>
